name: Continuos integration

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]

jobs:
    test:
        runs-on: ubuntu-latest
        env:
            DEV_MODE: "true"
            TEST_RUN: "true"
            GOOGLE_CLIENT_ID: "401008546765-0ecbubggp6gra24vlbno1v3bt4d6pnci.apps.googleusercontent.com"
            FRONTEND_URL: "http://localhost:5127"
            COOKIE_DOMAIN: "localhost"
            JWT_SECRET_ACCESS: "1fS96nCAldGuUQ9YpSJVIWAngCdbBG"
            JWT_SECRET_REFRESH: "2La9JgQhaWPXO1MRa14KMC3uGfBLuF"
            SESSION_EXP_TIME: "10800000"
            JWT_ACCESS_EXP: "3h"
            JWT_REFRESH_EXP: "3d"
            SWAGGER_HOST: "localhost:3000"
            SWAGGER_SCHEMA: "http"
        steps:
            - name: üì• Checkout repository
              uses: actions/checkout@v4

            - name: üì¶ Run doker compose
              run: docker compose up --build --exit-code-from main

            - name: ‚ùå Stop and remove containers
              run: docker compose down -v
              if: always()

    build:
        runs-on: ubuntu-latest
        needs: [ test ]
        steps:
            - name: üì• Checkout repository
              uses: actions/checkout@v4

            - name: üü® Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: üì¶ Install dependencies
              run: npm ci
              working-directory: server/

            - name: üîß Compile TypeScript
              run: npm run build
              working-directory: server/

            - name: ‚úÖ Show output files
              working-directory: server/
              run: ls -R dist

